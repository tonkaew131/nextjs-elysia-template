# Copilot instructions for this repository

These instructions tell Copilot Chat how to answer and act in this workspace. Keep responses concise, practical, and aligned with the stack and conventions below.

## Overview

- Monorepo managed with Bun workspaces: `api/` (Elysia + Drizzle) and `web/` (Next.js 15 + React 19 + Tailwind 4).
- Dev and DB commands are orchestrated from the repo root via Bun. Docker Compose files exist for dev/prod.
- Database is PostgreSQL. Migrations and snapshots are in `api/drizzle/` (generated by drizzle-kit).

## Package manager and scripts

- Use Bun, not npm/yarn/pnpm.
- Run from the repo root unless noted:
  - `bun run dev` — Starts both workspaces' dev servers (requires env via dotenv-cli).
  - `bun run format` — Prettier across workspaces with sorted imports.
  - DB:
    - `bun run db:gen` — Generate Drizzle migrations from schema.
    - `bun run db:migrate` — Apply migrations.
    - `bun run db:studio` — Open Drizzle Studio.
  - API types for web: `bun run api:gen` — Generate OpenAPI types in `web/src/libs/api/api.d.ts` from the API Swagger endpoint.
- When adding dependencies, prefer:
  - `bun add <pkg>` in the specific workspace (`api` or `web`).
  - Use ESM-compatible packages where possible.

## Tech stack specifics

### API (`api/`)

- Runtime: Bun + TypeScript (ES2022 modules, `strict` true, `skipLibCheck` true).
- Framework: Elysia with plugins:
  - `@elysiajs/swagger` exposes OpenAPI at `http://localhost:3001/swagger`.
  - `@elysiajs/cors` enabled.
- Entry: `src/app.ts` — registers controllers, centralizes error handling.
- Auth and test modules live in `src/auth/` and `src/test/`.
- Error model: `UnauthorizedError` mapped to HTTP 401 in `onError`.
- Database/ORM: Drizzle ORM with schema at `src/shared/db/schema.ts`.
  - Drizzle config: `api/drizzle.config.ts` (dialect: PostgreSQL, snake_case, `DATABASE_URL` required).
  - Migrations output: `api/drizzle/`. Do not hand-edit generated SQL or `meta/` snapshots.
- Conventions for new endpoints:
  - Create a controller module under `src/<feature>/<feature>.controller.ts` exporting an Elysia plugin.
  - Define request/response types (use `typebox`/Zod alternatives as applicable) and consistent error mapping.
  - Add route tags and schemas so Swagger stays complete. Ensure new routes appear in `/swagger` and validate via `web/src/libs/api/api.d.ts` regeneration.

### Web (`web/`)

- Framework: Next.js 15, React 19, app router. `next.config.ts` uses `output: 'standalone'`.
- TypeScript: strict, `moduleResolution: bundler`, path aliases:
  - `@/*` → `web/src/*`
  - `@public/*` → `web/public/*`
- Styling: Tailwind CSS v4. Prefer utility classes; keep class lists ordered logically. `prettier-plugin-tailwindcss` will sort Tailwind classes.
- Data fetching:
  - API types are generated to `web/src/libs/api/api.d.ts` via `bun run api:gen` from `http://localhost:3001/swagger/json`.
  - Use `openapi-fetch` or `openapi-react-query` consistent with existing patterns; prefer React Query for client-side data and caching.
- State/data:
  - React Query provider is in `src/components/query-provider.tsx`. Wrap client components that fetch data.

## Code style & linters

- Formatting: Prettier v3 with sorted imports (`@trivago/prettier-plugin-sort-imports`). Always let Prettier handle import order; avoid manual grouping that fights the plugin.
- ESLint (web): flat config extends Next.js and TanStack Query recommended rules. Fix lint errors or mark justified exceptions with comments.
- Module system: ESM. Use `import`/`export` consistently; avoid CommonJS.

## Generated artifacts (don’t edit)

- `web/src/libs/api/api.d.ts` — generated via `bun run api:gen`.
- `api/drizzle/**` — generated migrations and metadata.
- `volume/**` — Postgres persisted data mounted by Docker; never commit or modify programmatically.

## Environment & Docker

- `DATABASE_URL` must be set for Drizzle (`drizzle.config.ts`). Prefer `.env` with `dotenv-cli` used by root scripts.
- Docker Compose files:
  - `docker-compose.dev.yml`, `docker-compose.prod.yml`. Use them as optional orchestration; keep paths and ports consistent with the code (API default: `:3001`).

## When Copilot writes code

- Prefer TypeScript with explicit types on public functions and API contracts.
- For API routes:
  - Validate inputs and return typed responses.
  - Add appropriate error mapping in `onError` or local try/catch with error types.
  - Update Swagger schemas so clients can regenerate types successfully.
- For web components:
  - Use server components by default unless client interactivity is needed.
  - For client components, mark `'use client'` and use React Query for network data.
  - Keep components small and co-locate helpers in `src/libs/`.
- Keep imports sorted (the Prettier plugin will enforce), and respect path aliases.

## When Copilot runs commands

- Use Bun from the repo root unless a workspace-specific script is required:
  - Dev: `bun run dev`
  - Format: `bun run format`
  - DB: `bun run db:gen`, `bun run db:migrate`, `bun run db:studio`
  - API Types: `bun run api:gen` (ensure API server is running on `:3001` first)
- For new deps: run `bun add <pkg>` inside `api/` or `web/` accordingly.

## Guardrails (do/don’t)

- Do not edit generated files listed above.
- Do not introduce npm/yarn/pnpm commands; stick to Bun.
- Do not hardcode secrets. Use environment variables and document them.
- Keep Swagger definitions in sync with code. If a response/body changes, update its schema.
- Prefer small, focused PRs with a short test or a manual verification note.

## Acceptance checklist for changes

- [ ] Compiles and lints cleanly (`web` lint; `api` typechecks).
- [ ] Prettier applied (`bun run format`).
- [ ] API: Swagger shows new/changed routes and schemas without errors.
- [ ] Web: If API contracts changed, `bun run api:gen` regenerates types without type errors.
- [ ] No edits to generated or persisted data directories.

## Useful paths

- API entry: `api/src/app.ts`
- API controllers: `api/src/**/**.controller.ts`
- Drizzle schema: `api/src/shared/db/schema.ts`
- Drizzle config: `api/drizzle.config.ts`
- Web app router: `web/src/app/*`
- React Query provider: `web/src/components/query-provider.tsx`
- OpenAPI type generator: `web/src/libs/api/generate-type.ts`

---

If a convention isn’t covered here, infer from existing files in the same folder and prefer minimal, idiomatic solutions consistent with the stack above.
